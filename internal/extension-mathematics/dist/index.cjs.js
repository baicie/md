"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@tiptap/core"),t=require("@tiptap/pm/state"),i=require("@tiptap/pm/view");function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=o(require("katex"));const a=o=>{const{regex:a,katexOptions:r={},editor:s,shouldRender:d}=o;return new t.Plugin({key:new t.PluginKey("mathematics"),state:{init:()=>({decorations:void 0,isEditable:void 0}),apply(t,o,c,l){if(!t.docChanged&&!t.selectionSet&&o.decorations)return o;const p=(o.decorations||i.DecorationSet.empty).map(t.mapping,t.doc),{selection:m}=l,u=s.isEditable,h=[],{minFrom:f,maxTo:g}=function(t,i,o,n,a){let r=0,s=t.doc.nodeSize-2;return i.isEditable!==o?(r=0,s=t.doc.nodeSize-2):n.docChanged?(r=t.doc.nodeSize-2,s=0,e.getChangedRanges(n).forEach((e=>{r=Math.min(r,e.newRange.from),s=Math.max(s,e.newRange.to)}))):n.selectionSet&&(r=Math.min(a.selection.$from.before(),t.selection.$from.before()),s=Math.max(a.selection.$to.after(),t.selection.$to.after())),{minFrom:r,maxTo:s}}(l,o,u,t,c);l.doc.nodesBetween(f,g,((e,t)=>{const o=d(l,t,e);if(e.isText&&e.text&&o){let o;for(;o=a.exec(e.text);){const e=t+o.index,a=e+o[0].length,s=o.slice(1).find(Boolean);if(s){const t=m.from-m.to,o=m.anchor>=e&&m.anchor<=a,d=m.from>=e&&m.to<=a,c=0===t&&o||d;if(p.find(e,a,(e=>c===e.isEditing&&s===e.content&&u===e.isEditable&&r===e.katexOptions)).length)continue;h.push(i.Decoration.inline(e,a,{class:c&&u?"Tiptap-mathematics-editor":"Tiptap-mathematics-editor Tiptap-mathematics-editor--hidden",style:c&&u?void 0:"display: inline-block; height: 0; opacity: 0; overflow: hidden; position: absolute; width: 0;"},{content:s,isEditable:u,isEditing:c,katexOptions:r})),u&&c||h.push(i.Decoration.widget(e,(()=>{const e=document.createElement("span");e.classList.add("Tiptap-mathematics-render"),u&&e.classList.add("Tiptap-mathematics-render--editable");try{n.default.render(s,e,r)}catch(t){e.innerHTML=s}return e}),{content:s,isEditable:u,isEditing:c,katexOptions:r}))}}}}));const x=h.flatMap((e=>p.find(e.from,e.to)));return{decorations:p.remove(x).add(t.doc,h),isEditable:u}}},props:{decorations(e){var t,o;return null!==(o=null===(t=this.getState(e))||void 0===t?void 0:t.decorations)&&void 0!==o?o:i.DecorationSet.empty}}})},r=(e,t)=>!("codeBlock"===e.doc.resolve(t).parent.type.name),s=e.Extension.create({name:"Mathematics",addOptions:()=>({regex:/\$([^\$]*)\$/gi,katexOptions:void 0,shouldRender:r}),addProseMirrorPlugins(){return[a({...this.options,editor:this.editor})]}});exports.Mathematics=s,exports.MathematicsPlugin=a,exports.default=s,exports.defaultShouldRender=r;
