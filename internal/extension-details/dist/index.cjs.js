"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@tiptap/core"),e=require("@tiptap/pm/state"),n=require("@tiptap/pm/gapcursor");const o=(t,e)=>null!==e.view.domAtPos(t).node.offsetParent,s=(e,s)=>{const{state:r,view:i,extensionManager:a}=e,{schema:d,selection:c}=r,{empty:l,$anchor:p}=c,u=!!a.extensions.find((t=>"gapCursor"===t.name));if(!l||p.parent.type!==d.nodes.detailsSummary||!u)return!1;if("right"===s&&p.parentOffset!==p.parent.nodeSize-2)return!1;const m=t.findParentNode((t=>t.type===d.nodes.details))(c);if(!m)return!1;const f=t.findChildren(m.node,(t=>t.type===d.nodes.detailsContent));if(!f.length)return!1;if(o(m.start+f[0].pos+1,e))return!1;const h=r.doc.resolve(m.pos+m.node.nodeSize),y=n.GapCursor.findFrom(h,1,!1);if(!y)return!1;const{tr:g}=r,v=new n.GapCursor(y);return g.setSelection(v),g.scrollIntoView(),i.dispatch(g),!0},r=t.Node.create({name:"details",content:"detailsSummary detailsContent",group:"block",defining:!0,isolating:!0,allowGapCursor:!1,addOptions:()=>({persist:!1,openClassName:"is-open",HTMLAttributes:{}}),addAttributes(){return this.options.persist?{open:{default:!1,parseHTML:t=>t.hasAttribute("open"),renderHTML:({open:t})=>t?{open:""}:{}}}:[]},parseHTML:()=>[{tag:"details"}],renderHTML({HTMLAttributes:e}){return["details",t.mergeAttributes(this.options.HTMLAttributes,e),0]},addNodeView(){return({editor:e,getPos:n,node:o,HTMLAttributes:s})=>{const r=document.createElement("div"),i=t.mergeAttributes(this.options.HTMLAttributes,s,{"data-type":this.name});Object.entries(i).forEach((([t,e])=>r.setAttribute(t,e)));const a=document.createElement("button");a.type="button",r.append(a);const d=document.createElement("div");r.append(d);const c=t=>{if(void 0!==t)if(t){if(r.classList.contains(this.options.openClassName))return;r.classList.add(this.options.openClassName)}else{if(!r.classList.contains(this.options.openClassName))return;r.classList.remove(this.options.openClassName)}else r.classList.toggle(this.options.openClassName);const e=new Event("toggleDetailsContent"),n=d.querySelector(':scope > div[data-type="detailsContent"]');null==n||n.dispatchEvent(e)};return o.attrs.open&&setTimeout((()=>c())),a.addEventListener("click",(()=>{if(c(),this.options.persist){if(e.isEditable&&"function"==typeof n){const{from:t,to:o}=e.state.selection;e.chain().command((({tr:t})=>{const e=n(),o=t.doc.nodeAt(e);return(null==o?void 0:o.type)===this.type&&(t.setNodeMarkup(e,void 0,{open:!o.attrs.open}),!0)})).setTextSelection({from:t,to:o}).focus(void 0,{scrollIntoView:!1}).run()}}else e.commands.focus(void 0,{scrollIntoView:!1})})),{dom:r,contentDOM:d,ignoreMutation:t=>"selection"!==t.type&&(!r.contains(t.target)||r===t.target),update:t=>t.type===this.type&&(void 0!==t.attrs.open&&c(t.attrs.open),!0)}}},addCommands(){return{setDetails:()=>({state:t,chain:e})=>{var n;const{schema:o,selection:s}=t,{$from:r,$to:i}=s,a=r.blockRange(i);if(!a)return!1;const d=t.doc.slice(a.start,a.end);if(!o.nodes.detailsContent.contentMatch.matchFragment(d.content))return!1;const c=(null===(n=d.toJSON())||void 0===n?void 0:n.content)||[];return e().insertContentAt({from:a.start,to:a.end},{type:this.name,content:[{type:"detailsSummary"},{type:"detailsContent",content:c}]}).setTextSelection(a.start+2).run()},unsetDetails:()=>({state:e,chain:n})=>{const{selection:o,schema:s}=e,r=t.findParentNode((t=>t.type===this.type))(o);if(!r)return!1;const i=t.findChildren(r.node,(t=>t.type===s.nodes.detailsSummary)),a=t.findChildren(r.node,(t=>t.type===s.nodes.detailsContent));if(!i.length||!a.length)return!1;const d=i[0],c=a[0],l=r.pos,p=e.doc.resolve(l),u={from:l,to:l+r.node.nodeSize},m=c.node.content.toJSON()||[],f=p.parent.type.contentMatch.defaultType,h=[null==f?void 0:f.create(null,d.node.content).toJSON(),...m];return n().insertContentAt(u,h).setTextSelection(l+1).run()}}},addKeyboardShortcuts(){return{Backspace:()=>{const{schema:t,selection:e}=this.editor.state,{empty:n,$anchor:o}=e;return!(!n||o.parent.type!==t.nodes.detailsSummary)&&(0!==o.parentOffset?this.editor.commands.command((({tr:t})=>{const e=o.pos-1,n=o.pos;return t.delete(e,n),!0})):this.editor.commands.unsetDetails())},Enter:({editor:n})=>{const{state:s,view:r}=n,{schema:i,selection:a}=s,{$head:d}=a;if(d.parent.type!==i.nodes.detailsSummary)return!1;const c=o(d.after()+1,n),l=c?s.doc.nodeAt(d.after()):d.node(-2);if(!l)return!1;const p=c?0:d.indexAfter(-1),u=t.defaultBlockAt(l.contentMatchAt(p));if(!u||!l.canReplaceWith(p,p,u))return!1;const m=u.createAndFill();if(!m)return!1;const f=c?d.after()+1:d.after(-1),h=s.tr.replaceWith(f,f,m),y=h.doc.resolve(f),g=e.Selection.near(y,1);return h.setSelection(g),h.scrollIntoView(),r.dispatch(h),!0},ArrowRight:({editor:t})=>s(t,"right"),ArrowDown:({editor:t})=>s(t,"down")}},addProseMirrorPlugins(){return[new e.Plugin({key:new e.PluginKey("detailsSelection"),appendTransaction:(n,s,r)=>{const{editor:i,type:a}=this,d=n.some((t=>t.selectionSet));if(!d||!s.selection.empty||!r.selection.empty)return;if(!t.isActive(r,a.name))return;const{$from:c}=r.selection;if(o(c.pos,i))return;const l=((t,e,n)=>{for(let s=t.depth;s>0;s-=1){const r=t.node(s),i=e(r),a=o(t.start(s),n);if(i&&a)return{pos:s>0?t.before(s):0,start:t.start(s),depth:s,node:r}}})(c,(t=>t.type===a),i);if(!l)return;const p=t.findChildren(l.node,(t=>t.type===r.schema.nodes.detailsSummary));if(!p.length)return;const u=p[0],m="forward"===(s.selection.from<r.selection.from?"forward":"backward")?l.start+u.pos:l.pos+u.pos+u.node.nodeSize,f=e.TextSelection.create(r.doc,m);return r.tr.setSelection(f)}})]}});exports.Details=r,exports.default=r;
